<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            color: #111827;
        }
        
        .hidden { display: none !important; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #7c3aed, #3b82f6, #4338ca);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2rem;
            width: 100%;
            max-width: 28rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .icon-large {
            width: 4rem;
            height: 4rem;
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
        }
        
        .title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .input:focus {
            outline: none;
            ring: 2px;
            ring-color: #7c3aed;
            border-color: transparent;
        }
        
        .textarea {
            resize: none;
            font-family: inherit;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #6d28d9, #2563eb);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-large {
            padding: 1rem 1.5rem;
            font-size: 1.125rem;
        }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .success {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0369a1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        .link-btn {
            background: none;
            border: none;
            color: #7c3aed;
            cursor: pointer;
            font-weight: 500;
            text-decoration: underline;
        }
        
        .link-btn:hover {
            color: #6d28d9;
        }
        
        .main-layout {
            min-height: 100vh;
            display: flex;
        }
        
        .sidebar {
            width: 20rem;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .sidebar-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .icon-small {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }
        
        .user-info h3 {
            font-weight: bold;
            color: #1f2937;
        }
        
        .user-info p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }
        
        .nav-tab {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .nav-tab.active {
            background: #f3f4f6;
            color: #7c3aed;
        }
        
        .nav-tab:not(.active) {
            color: #6b7280;
        }
        
        .nav-tab:not(.active):hover {
            background: #f9fafb;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .content-area {
            flex: 1;
            padding: 2rem;
        }
        
        .content-center {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100%;
        }
        
        .content-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 64rem;
        }
        
        .content-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .content-title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .history-item {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .history-header {
            margin-bottom: 1rem;
        }
        
        .history-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .history-date {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .image-card {
            text-align: center;
        }
        
        .image-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: #374151;
        }
        
        .status-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
        }
        
        .status-dalle { background: #ef4444; }
        .status-stable { background: #10b981; }
        .status-midjourney { background: #3b82f6; }
        
        .image-preview {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .image-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.2);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
        }
        
        .modal-content {
            position: relative;
            max-width: 64rem;
            max-height: 100%;
        }
        
        .modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: white;
            color: #1f2937;
            padding: 0.5rem;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: #f3f4f6;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
        }
        
        .empty-icon {
            font-size: 4rem;
            color: #d1d5db;
            margin-bottom: 1rem;
        }
        
        .empty-title {
            font-size: 1.25rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .empty-text {
            color: #9ca3af;
            margin-bottom: 1.5rem;
        }
        
        .history-sidebar-item {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-sidebar-item:hover {
            background: #f9fafb;
        }
        
        .history-sidebar-title {
            font-size: 0.875rem;
            color: #1f2937;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .history-sidebar-date {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: fixed;
                top: 0;
                left: -100%;
                height: 100vh;
                z-index: 40;
                transition: left 0.3s;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .main-content {
                width: 100%;
            }
            
            .image-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Page -->
    <div id="auth-page" class="gradient-bg">
        <div class="card">
            <div class="header">
                <div class="icon-large">✨</div>
                <h1 class="title">AI Image Generator</h1>
                <p class="subtitle">Comparez DALL-E, Stable Diffusion et Midjourney</p>
            </div>

            <div class="form-group">
                <label class="label">Email</label>
                <input type="email" id="email" class="input" placeholder="votre@email.com" required>
            </div>

            <div class="form-group">
                <label class="label">Mot de passe</label>
                <input type="password" id="password" class="input" placeholder="••••••••" required>
            </div>

            <div id="auth-error" class="hidden error"></div>

            <button id="auth-btn" class="btn">
                <span id="auth-text">Se connecter</span>
                <span id="auth-loader" class="hidden spinning">⏳</span>
            </button>

            <div style="margin-top: 1.5rem; text-align: center;">
                <button id="toggle-auth" class="link-btn">Créer un compte</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Header -->
            <div class="sidebar-header">
                <div class="sidebar-profile">
                    <div class="icon-small">✨</div>
                    <div class="user-info">
                        <h3>AI Generator</h3>
                        <p id="user-email"></p>
                    </div>
                </div>
                
                <div class="nav-tabs">
                    <button id="nav-generate" class="nav-tab active">
                        💬 Générer
                    </button>
                    <button id="nav-history" class="nav-tab">
                        📋 Historique
                    </button>
                </div>
            </div>

            <!-- History List -->
            <div class="sidebar-content">
                <h3 style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.75rem;">Générations récentes</h3>
                <div id="sidebar-history">
                    <!-- History items will be inserted here -->
                </div>
            </div>

            <!-- Footer -->
            <div class="sidebar-footer">
                <button id="logout-btn" class="btn">
                    🚪 Se déconnecter
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Generate View -->
            <div id="generate-view" class="content-area">
                <div class="content-center">
                    <div class="content-card">
                        <div class="content-header">
                            <h2 class="content-title">Générez des images avec 3 IA</h2>
                            <p class="subtitle">Comparez DALL-E 3, Stable Diffusion XL et Midjourney en un clic</p>
                        </div>

                        <div class="form-group">
                            <label class="label">Décrivez l'image que vous voulez générer</label>
                            <textarea id="prompt-input" class="input textarea" rows="4" placeholder="Ex: Un chat astronaute sur la lune en style cartoon, très détaillé, couleurs vives..."></textarea>
                        </div>

                        <button id="generate-btn" class="btn btn-large">
                            <span id="generate-icon">✨</span>
                            <span id="generate-text">Générer avec 3 IA</span>
                        </button>

                        <div id="generate-error" class="hidden error"></div>

                        <div id="generate-progress" class="hidden success">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span class="spinning">⏳</span>
                                <span style="font-weight: 500;">Génération en cours...</span>
                            </div>
                            <p style="margin-top: 0.5rem; font-size: 0.875rem;">DALL-E 3, Stable Diffusion XL et Midjourney travaillent sur votre prompt</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History View -->
            <div id="history-view" class="hidden content-area">
                <div style="margin-bottom: 2rem;">
                    <h2 class="content-title">Historique des générations</h2>
                    <p class="subtitle">Toutes vos créations AI en un coup d'œil</p>
                </div>

                <div id="history-content">
                    <!-- History items will be inserted here -->
                </div>

                <div id="empty-history" class="hidden empty-state">
                    <div class="empty-icon">🖼️</div>
                    <h3 class="empty-title">Aucune génération</h3>
                    <p class="empty-text">Commencez par générer votre première image</p>
                    <button id="start-generate" class="btn">Générer une image</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="hidden modal">
        <div class="modal-content">
            <img id="modal-image" class="modal-image">
            <button id="close-modal" class="modal-close">✕</button>
        </div>
    </div>

    <script>
        // Configuration
        const N8N_WEBHOOK_URL = "https://danytherrien.app.n8n.cloud/webhook/generate-images";
        const N8N_STATUS_URL = "https://danytherrien.app.n8n.cloud/webhook/status";
        const N8N_API_BASE = "https://danytherrien.app.n8n.cloud/api/v1";
        
        // State
        let currentUser = null;
        let authMode = 'login';
        let currentView = 'generate';
        let generationHistory = [];

        // DOM Elements
        const authPage = document.getElementById('auth-page');
        const mainApp = document.getElementById('main-app');
        const authBtn = document.getElementById('auth-btn');
        const authText = document.getElementById('auth-text');
        const authLoader = document.getElementById('auth-loader');
        const authError = document.getElementById('auth-error');
        const toggleAuth = document.getElementById('toggle-auth');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const userEmailSpan = document.getElementById('user-email');
        const generateView = document.getElementById('generate-view');
        const historyView = document.getElementById('history-view');
        const navGenerate = document.getElementById('nav-generate');
        const navHistory = document.getElementById('nav-history');
        const promptInput = document.getElementById('prompt-input');
        const generateBtn = document.getElementById('generate-btn');
        const generateIcon = document.getElementById('generate-icon');
        const generateText = document.getElementById('generate-text');
        const generateError = document.getElementById('generate-error');
        const generateProgress = document.getElementById('generate-progress');
        const historyContent = document.getElementById('history-content');
        const emptyHistory = document.getElementById('empty-history');
        const sidebarHistory = document.getElementById('sidebar-history');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const closeModal = document.getElementById('close-modal');
        const logoutBtn = document.getElementById('logout-btn');
        const startGenerate = document.getElementById('start-generate');

        // Event Listeners
        authBtn.addEventListener('click', handleAuth);
        toggleAuth.addEventListener('click', toggleAuthMode);
        navGenerate.addEventListener('click', () => switchView('generate'));
        navHistory.addEventListener('click', () => switchView('history'));
        generateBtn.addEventListener('click', handleGenerate);
        logoutBtn.addEventListener('click', handleLogout);
        startGenerate.addEventListener('click', () => switchView('generate'));
        closeModal.addEventListener('click', () => imageModal.classList.add('hidden'));

        // Functions
        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            authText.textContent = authMode === 'login' ? 'Se connecter' : 'S\'inscrire';
            toggleAuth.textContent = authMode === 'login' ? 'Créer un compte' : 'Déjà un compte ? Se connecter';
        }

        async function handleAuth() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !password) {
                showError('Veuillez remplir tous les champs');
                return;
            }

            if (authMode === 'register' && password.length < 6) {
                showError('Le mot de passe doit contenir au moins 6 caractères');
                return;
            }

            setLoading(true);
            hideError();

            try {
                // Simulate auth
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                currentUser = {
                    email: email,
                    uid: email.replace('@', '_').replace('.', '_')
                };

                userEmailSpan.textContent = email;
                authPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                loadHistory();
                
                // Test des APIs disponibles
                testExecutionsAPI();
                
            } catch (error) {
                showError('Erreur de connexion');
            } finally {
                setLoading(false);
            }
        }

        function setLoading(loading) {
            if (loading) {
                authLoader.classList.remove('hidden');
                authText.textContent = 'Connexion...';
                authBtn.disabled = true;
            } else {
                authLoader.classList.add('hidden');
                authText.textContent = authMode === 'login' ? 'Se connecter' : 'S\'inscrire';
                authBtn.disabled = false;
            }
        }

        function showError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }

        function hideError() {
            authError.classList.add('hidden');
        }

        function switchView(view) {
            currentView = view;
            
            if (view === 'generate') {
                generateView.classList.remove('hidden');
                historyView.classList.add('hidden');
                navGenerate.classList.add('active');
                navHistory.classList.remove('active');
            } else {
                generateView.classList.add('hidden');
                historyView.classList.remove('hidden');
                navGenerate.classList.remove('active');
                navHistory.classList.add('active');
            }
        }

        async function handleGenerate() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const generationId = Date.now().toString();
            setGenerating(true);
            hideGenerateError();

            try {
                // Déclencher la génération sur n8n
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        email: currentUser.email,
                        generationId: generationId
                    })
                });

                if (!response.ok) {
                    throw new Error('Erreur réseau');
                }

                // Créer l'entrée en attente
                const pendingGeneration = {
                    id: generationId,
                    prompt: prompt,
                    status: 'generating',
                    progress: 0,
                    dalle_url: null,
                    stable_url: null,
                    midjourney_url: null,
                    dalle_status: "generating",
                    stable_status: "generating",
                    midjourney_status: "generating",
                    timestamp: new Date(),
                    userId: currentUser.uid
                };

                generationHistory.unshift(pendingGeneration);
                promptInput.value = '';
                updateHistory();
                switchView('history');

                // Démarrer le polling pour vérifier l'état
                startPolling(generationId);

            } catch (error) {
                console.error('Erreur génération:', error);
                showGenerateError('Erreur lors de la génération. Mode démo activé.');
                
                // Fallback demo
                const fallbackGeneration = {
                    id: generationId,
                    prompt: prompt,
                    dalle_url: `https://via.placeholder.com/512x512/ef4444/white?text=${encodeURIComponent('DALL-E: ' + prompt.slice(0, 20))}`,
                    stable_url: `https://via.placeholder.com/512x512/10b981/white?text=${encodeURIComponent('SD: ' + prompt.slice(0, 20))}`,
                    midjourney_url: `https://via.placeholder.com/512x512/3b82f6/white?text=${encodeURIComponent('MJ: ' + prompt.slice(0, 20))}`,
                    dalle_status: "demo",
                    stable_status: "demo",
                    midjourney_status: "demo",
                    status: "completed",
                    progress: 100,
                    timestamp: new Date(),
                    userId: currentUser.uid
                };

                generationHistory.unshift(fallbackGeneration);
                promptInput.value = '';
                updateHistory();
                switchView('history');
            } finally {
                setGenerating(false);
            }
        }

        async function startPolling(generationId) {
            const maxPollingTime = 90 * 60 * 1000; // 90 minutes max
            const pollingInterval = 30 * 1000; // 30 secondes
            const startTime = Date.now();

            const pollInterval = setInterval(async () => {
                const elapsed = Date.now() - startTime;

                try {
                    // NOUVELLE APPROCHE : Consulter directement les exécutions du workflow principal
                    const executionsResponse = await fetch(`${N8N_API_BASE}/executions?workflowId=Image%20generator%20IA&limit=5`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    let progressPercentage = Math.min(90, Math.floor((elapsed / maxPollingTime) * 100));
                    let statusData = null;

                    if (executionsResponse.ok) {
                        const executionsData = await executionsResponse.json();
                        console.log('✅ Exécutions récupérées:', executionsData);
                        
                        // Chercher notre exécution par generationId ou timestamp
                        const ourExecution = executionsData.data?.find(exec => {
                            const execTime = new Date(exec.startedAt).getTime();
                            const genTime = parseInt(generationId);
                            return Math.abs(execTime - genTime) < 120000; // 2 minutes de tolérance
                        });

                        if (ourExecution) {
                            console.log('🎯 Exécution trouvée:', ourExecution);
                            
                            if (ourExecution.finished && ourExecution.mode === 'manual') {
                                // Récupérer les détails de l'exécution
                                const detailResponse = await fetch(`${N8N_API_BASE}/executions/${ourExecution.id}`);
                                if (detailResponse.ok) {
                                    const executionDetail = await detailResponse.json();
                                    console.log('📋 Détails exécution:', executionDetail);
                                    
                                    // Extraire les URLs des images depuis les nœuds
                                    const nodeData = executionDetail.data?.resultData?.runData;
                                    if (nodeData) {
                                        const dalleUrl = nodeData['OpenAI']?.[0]?.data?.main?.[0]?.json?.data?.[0]?.url;
                                        const stableUrl = nodeData['Stable Diffusion XL1']?.[0]?.data?.main?.[0]?.json?.artifacts?.[0]?.base64;
                                        const mjUrl = nodeData['Confirmer Réception']?.[0]?.data?.main?.[0]?.json?.url;
                                        
                                        if (dalleUrl || stableUrl || mjUrl) {
                                            console.log('🖼️ Images trouvées!', { dalleUrl, stableUrl, mjUrl });
                                            
                                            statusData = {
                                                status: 'completed',
                                                progress: 100,
                                                dalle_url: dalleUrl,
                                                stable_url: stableUrl ? `data:image/png;base64,${stableUrl}` : null,
                                                midjourney_url: mjUrl
                                            };
                                        }
                                    }
                                }
                            } else if (ourExecution.stoppedAt) {
                                // Exécution terminée en échec
                                statusData = { status: 'failed', progress: 0 };
                            } else {
                                // Exécution en cours
                                const execElapsed = Date.now() - new Date(ourExecution.startedAt).getTime();
                                progressPercentage = Math.min(95, Math.floor((execElapsed / (45 * 60 * 1000)) * 100)); // 45 min estimate
                                statusData = { status: 'generating', progress: progressPercentage };
                            }
                        }
                    } else {
                        console.warn('⚠️ API Executions erreur:', executionsResponse.status);
                        // Fallback vers l'ancienne API de status
                        const statusResponse = await fetch(`${N8N_STATUS_URL}?id=${generationId}`);
                        if (statusResponse.ok) {
                            statusData = await statusResponse.json();
                            progressPercentage = parseInt(statusData.progress) || progressPercentage;
                        }
                    }

                    // Mettre à jour la progression avec une valeur numérique garantie
                    updateGenerationProgress(generationId, progressPercentage);

                    // Vérifier si c'est terminé
                    if (statusData && statusData.status === 'completed' && statusData.dalle_url) {
                        console.log('🎉 Génération terminée!', statusData);
                        
                        const completedGeneration = {
                            dalle_url: statusData.dalle_url,
                            stable_url: statusData.stable_url || `https://via.placeholder.com/512x512/10b981/white?text=SD-Processed`,
                            midjourney_url: statusData.midjourney_url || `https://via.placeholder.com/512x512/3b82f6/white?text=MJ-Processed`,
                            dalle_status: statusData.dalle_url ? "success" : "demo",
                            stable_status: statusData.stable_url ? "success" : "demo",
                            midjourney_status: statusData.midjourney_url ? "success" : "demo",
                            status: "completed",
                            progress: 100
                        };

                        completeGeneration(generationId, completedGeneration);
                        clearInterval(pollInterval);
                        return;
                    }

                    if (statusData && statusData.status === 'failed') {
                        console.warn('❌ Génération échouée');
                        clearInterval(pollInterval);
                        failGeneration(generationId);
                        return;
                    }

                } catch (error) {
                    console.error('❌ Erreur polling:', error);
                    // Progression de fallback basée sur le temps
                    const fallbackProgress = Math.min(95, Math.floor((elapsed / maxPollingTime) * 100));
                    updateGenerationProgress(generationId, fallbackProgress);
                }

                // Timeout après 90 minutes
                if (elapsed > maxPollingTime) {
                    console.warn('⏰ Timeout génération après 90 minutes');
                    clearInterval(pollInterval);
                    failGeneration(generationId);
                }
            }, pollingInterval);

            // Premier appel immédiat après 5 secondes
            setTimeout(async () => {
                console.log(`🚀 Démarrage du polling pour la génération ${generationId}`);
                updateGenerationProgress(generationId, 5);
            }, 5000);
        }

        function updateGenerationProgress(generationId, progress) {
            const generation = generationHistory.find(g => g.id === generationId);
            if (generation) {
                // S'assurer que progress est un nombre valide
                const validProgress = Math.max(0, Math.min(100, parseInt(progress) || 0));
                generation.progress = validProgress;
                console.log(`📊 Progression mise à jour: ${generationId} → ${validProgress}%`);
                updateHistory();
            }
        }

        function completeGeneration(generationId, results) {
            const generation = generationHistory.find(g => g.id === generationId);
            if (generation) {
                Object.assign(generation, results);
                updateHistory();
                
                // Notification visuelle
                if (generateError.classList.contains('hidden')) {
                    generateError.classList.remove('hidden');
                    generateError.className = generateError.className.replace('error', 'success');
                    generateError.style.background = '#f0f9ff';
                    generateError.style.borderColor = '#bae6fd';
                    generateError.style.color = '#0369a1';
                }
                generateError.textContent = '✅ Génération terminée ! Vos images sont prêtes.';
                setTimeout(() => {
                    hideGenerateError();
                    generateError.className = generateError.className.replace('success', 'error');
                    generateError.style.background = '';
                    generateError.style.borderColor = '';
                    generateError.style.color = '';
                }, 5000);
            }
        }

        // Fonction de test pour vérifier l'API des exécutions
        async function testExecutionsAPI() {
            try {
                const testResponse = await fetch(`${N8N_API_BASE}/executions?limit=1`);
                if (testResponse.ok) {
                    const data = await testResponse.json();
                    console.log('✅ API Executions accessible:', data);
                    return true;
                } else {
                    console.warn('⚠️ API Executions protégée:', testResponse.status);
                    // Tester l'API de status en fallback
                    return await testStatusAPI();
                }
            } catch (error) {
                console.error('❌ API Executions inaccessible:', error);
                return await testStatusAPI();
            }
        }

        // Fonction de test pour vérifier l'API de status
        async function testStatusAPI() {
            try {
                const testResponse = await fetch(`${N8N_STATUS_URL}?id=test123`);
                if (testResponse.ok) {
                    const data = await testResponse.json();
                    console.log('✅ API Status fonctionne:', data);
                    return true;
                } else {
                    console.warn('⚠️ API Status erreur:', testResponse.status);
                    return false;
                }
            } catch (error) {
                console.error('❌ API Status inaccessible:', error);
                return false;
            }
        }

        function failGeneration(generationId) {
            const generation = generationHistory.find(g => g.id === generationId);
            if (generation) {
                generation.status = "failed";
                generation.progress = 0;
                updateHistory();
            }
        }

        function setGenerating(generating) {
            if (generating) {
                generateIcon.textContent = '⏳';
                generateIcon.classList.add('spinning');
                generateText.textContent = 'Génération en cours... (3 IA en parallèle)';
                generateBtn.disabled = true;
                generateProgress.classList.remove('hidden');
            } else {
                generateIcon.textContent = '✨';
                generateIcon.classList.remove('spinning');
                generateText.textContent = 'Générer avec 3 IA';
                generateBtn.disabled = false;
                generateProgress.classList.add('hidden');
            }
        }

        function showGenerateError(message) {
            generateError.textContent = message;
            generateError.classList.remove('hidden');
        }

        function hideGenerateError() {
            generateError.classList.add('hidden');
        }

        function loadHistory() {
            // Load from localStorage
            const saved = localStorage.getItem(`history_${currentUser.uid}`);
            if (saved) {
                try {
                    generationHistory = JSON.parse(saved);
                } catch (e) {
                    generationHistory = [];
                }
            }
            updateHistory();
        }

        function updateHistory() {
            // Save to localStorage
            localStorage.setItem(`history_${currentUser.uid}`, JSON.stringify(generationHistory));

            // Update sidebar
            sidebarHistory.innerHTML = '';
            generationHistory.slice(0, 10).forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-sidebar-item';
                div.onclick = () => switchView('history');
                
                const progress = parseInt(item.progress) || 0;
                const statusIndicator = item.status === 'generating' ? 
                    `<span style="color: #3b82f6;">🔄 ${progress}%</span>` : 
                    item.status === 'failed' ? 
                    `<span style="color: #ef4444;">❌ Échec</span>` : 
                    `<span style="color: #10b981;">✅ Terminé</span>`;
                
                div.innerHTML = `
                    <div class="history-sidebar-title">${item.prompt}</div>
                    <div class="history-sidebar-date">${new Date(item.timestamp).toLocaleDateString()} ${statusIndicator}</div>
                `;
                sidebarHistory.appendChild(div);
            });

            // Update main history
            if (generationHistory.length === 0) {
                historyContent.innerHTML = '';
                emptyHistory.classList.remove('hidden');
            } else {
                emptyHistory.classList.add('hidden');
                
                historyContent.innerHTML = '';
                generationHistory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    
                    let contentHTML;
                    
                    if (item.status === 'generating') {
                        // Affichage avec barre de progression
                        const progress = parseInt(item.progress) || 0;
                        const estimatedTime = progress > 0 ? Math.round((100 - progress) * 1.5) : 90; // Estimation en minutes
                        
                        contentHTML = `
                            <div class="history-header">
                                <h3 class="history-title">${item.prompt}</h3>
                                <p class="history-date">${new Date(item.timestamp).toLocaleDateString()} à ${new Date(item.timestamp).toLocaleTimeString()}</p>
                            </div>
                            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <span class="spinning">⏳</span>
                                    <span style="font-weight: 500; color: #0369a1;">Génération en cours... ${progress}%</span>
                                </div>
                                <div style="background: #e0f2fe; border-radius: 0.25rem; height: 0.5rem; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #3b82f6, #10b981); height: 100%; width: ${progress}%; transition: width 0.5s;"></div>
                                </div>
                                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #0369a1;">
                                    Temps estimé restant: ~${estimatedTime} minutes
                                </p>
                                <p style="font-size: 0.875rem; color: #0369a1;">
                                    DALL-E 3, Stable Diffusion XL et Midjourney travaillent sur votre prompt
                                </p>
                            </div>
                            <div class="image-grid">
                                <div class="image-card">
                                    <div class="image-label">
                                        <div class="status-dot" style="background: #6b7280;"></div>
                                        DALL-E 3 - En cours
                                    </div>
                                    <div style="width: 100%; aspect-ratio: 1; background: #f3f4f6; border-radius: 0.5rem; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                                        <span class="spinning">⏳</span>
                                    </div>
                                </div>
                                <div class="image-card">
                                    <div class="image-label">
                                        <div class="status-dot" style="background: #6b7280;"></div>
                                        Stable Diffusion XL - En cours
                                    </div>
                                    <div style="width: 100%; aspect-ratio: 1; background: #f3f4f6; border-radius: 0.5rem; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                                        <span class="spinning">⏳</span>
                                    </div>
                                </div>
                                <div class="image-card">
                                    <div class="image-label">
                                        <div class="status-dot" style="background: #6b7280;"></div>
                                        Midjourney - En cours
                                    </div>
                                    <div style="width: 100%; aspect-ratio: 1; background: #f3f4f6; border-radius: 0.5rem; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                                        <span class="spinning">⏳</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (item.status === 'failed') {
                        // Affichage d'échec
                        contentHTML = `
                            <div class="history-header">
                                <h3 class="history-title">${item.prompt}</h3>
                                <p class="history-date">${new Date(item.timestamp).toLocaleDateString()} à ${new Date(item.timestamp).toLocaleTimeString()}</p>
                            </div>
                            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 1rem; color: #dc2626;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span>❌</span>
                                    <span style="font-weight: 500;">Échec de la génération - Timeout après 90 minutes</span>
                                </div>
                                <p style="margin-top: 0.5rem; font-size: 0.875rem;">Vous pouvez réessayer avec un prompt différent.</p>
                            </div>
                        `;
                    } else {
                        // Affichage normal avec images
                        contentHTML = `
                            <div class="history-header">
                                <h3 class="history-title">${item.prompt}</h3>
                                <p class="history-date">${new Date(item.timestamp).toLocaleDateString()} à ${new Date(item.timestamp).toLocaleTimeString()}</p>
                            </div>
                            <div class="image-grid">
                                <div class="image-card">
                                    <div class="image-label">
                                        <div class="status-dot status-dalle"></div>
                                        DALL-E 3
                                    </div>
                                    <img src="${item.dalle_url}" alt="DALL-E generation" class="image-preview" onclick="openModal('${item.dalle_url}')">
                                </div>
                                <div class="image-card">
                                    <div class="image-label">
                                        <div class="status-dot status-stable"></div>
                                        Stable Diffusion XL
                                    </div>
                                    <img src="${item.stable_url}" alt="Stable Diffusion generation" class="image-preview" onclick="openModal('${item.stable_url}')">
                                </div>
                                <div class="image-card">
                                    <div class="image-label">
                                        <div class="status-dot status-midjourney"></div>
                                        Midjourney
                                    </div>
                                    <img src="${item.midjourney_url}" alt="Midjourney generation" class="image-preview" onclick="openModal('${item.midjourney_url}')">
                                </div>
                            </div>
                        `;
                    }
                    
                    div.innerHTML = contentHTML;
                    historyContent.appendChild(div);
                });
            }
        }

        function openModal(imageSrc) {
            modalImage.src = imageSrc;
            imageModal.classList.remove('hidden');
        }

        function handleLogout() {
            currentUser = null;
            generationHistory = [];
            authPage.classList.remove('hidden');
            mainApp.classList.add('hidden');
            emailInput.value = '';
            passwordInput.value = '';
            promptInput.value = '';
            switchView('generate');
        }
    </script>
</body>
</html>
